name: "PR"

on:
  pull_request:

env:
  INT_ACCOUNT_ID: 12345
  INT_NON_PROD_ACCOUNT_ID: 56789
  INT_PROD_ACCOUNT_ID: 99999

permissions:
  id-token: write
  contents: read
  pull-requests: read
  checks: write

jobs:
  run-tf-plan:
    name: "Run TF Plan"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository to the runner
        uses: actions/checkout@v2

      - name: Setup Terraform with specified version on the runner
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0
    
      - name: Terraform init
        id: init
        run: terraform init

      - name: Terraform Plan (capture exit code)
        run: |
          terraform plan -detailed-exitcode -out=tfplan.out || echo $? > tf_exit_code.txt
          if [ ! -f tf_exit_code.txt ]; then echo 0 > tf_exit_code.txt; fi
          cat tf_exit_code.txt
        continue-on-error: true

      - name: Read exit code as output
        id: plan_code
        run: |
          code=$(cat tf_exit_code.txt)
          echo "Terraform exit code: $code"
          echo "exit_code=$code" >> $GITHUB_OUTPUT

      - name: Act on Plan Result
        run: |
          code=${{ steps.plan_code.outputs.exit_code }}
          echo "Terraform returned: $code"
          if [[ "$code" == "2" ]]; then
            echo "âœ… Terraform detected changes"
          elif [[ "$code" == "0" ]]; then
            echo "ğŸŸ¢ No changes"
          else
            echo "âŒ Error running terraform plan"
            exit 1
          fi
